<html>
<head>
<title>Screen over WebSockets</title>
<body>
</body>
<script>
  "use strict";

  // -- Create Canvas
  var canvas = document.createElement("CANVAS");
  canvas.width = canvas.height = GUI_SCREEN_SIZE;
  document.body.appendChild(canvas);
  var ctx = canvas.getContext('2d');
  // --

  // -- Initialise ArrayBuffers
  var imagedata = ctx.getImageData(0,0,canvas.width, canvas.height);
  var offset = function(x,y) {return (y * canvas.width + x) * 4;}
  // var guiPacket = new ArrayBuffer(9);
  // var guiPacketData = new Uint8Array(guiPacket);
  // var pixel = ctx.createImageData(1,1);
  // --

  // -- Establish WebSocket
  var ws = new WebSocket("ws://GUI_IP/", "single-pixel-GUI-protocol");
  ws.binaryType = 'arraybuffer';
  ws.onopen = function() {ws.send("GUI Ready");};
  ws.onmessage = function(e) {
    var guiPacketData = new Uint8Array(e.data);
    var cmd = guiPacketData[0] & 7;
    switch (cmd) {
      case 2:
        var xHi = guiPacketData[1];
        var xLo = guiPacketData[2];
        var yHi = guiPacketData[3];
        var yLo = guiPacketData[4];
        var R = guiPacketData[5];
        var G = guiPacketData[6];
        var B = guiPacketData[7];
        var A = guiPacketData[8];
        // pixel.data[0] = guiPacketData[5];
        // pixel.data[1] = guiPacketData[6];
        // pixel.data[2] = guiPacketData[7];
        // pixel.data[3] = guiPacketData[8];
        var x = xHi * 256 + xLo;
        var y = yHi * 256 + yLo;
        // ctx.putImageData(pixel,x,y);
        imagedata.data[offset(x,y) + 0] = R;
        imagedata.data[offset(x,y) + 1] = G;
        imagedata.data[offset(x,y) + 2] = B;
        imagedata.data[offset(x,y) + 3] = A;
        break;
      case 4:
        var xHi = guiPacketData[1];
        var xLo = guiPacketData[2];
        var yHi = guiPacketData[3];
        var yLo = guiPacketData[4];
        var wHi = guiPacketData[5];
        var wLo = guiPacketData[6];
        var hHi = guiPacketData[7];
        var hLo = guiPacketData[8];
        var R = guiPacketData[9];
        var G = guiPacketData[10];
        var B = guiPacketData[11];
        var A = guiPacketData[12];
        var x = xHi * 256 + xLo;
        var y = yHi * 256 + yLo;
        var w = wHi * 256 + wLo;
        var h = hHi * 256 + hLo;
        for (var i = x; i <= x+w; i++){
          for (var j = y; j <= y+h; j++) {
            imagedata.data[offset(i,j) + 0] = R;
            imagedata.data[offset(i,j) + 1] = G;
            imagedata.data[offset(i,j) + 2] = B;
            imagedata.data[offset(i,j) + 3] = A;
          }
        }
        break;
      default:
    }
  };
  // --

  // -- Refresh screen as fast as can draw
  function refresh(){
    ctx.putImageData(imagedata,0,0);
    window.requestAnimationFrame(refresh);
  }
  window.requestAnimationFrame(refresh);
  // --

</script>

</head>
</html>
